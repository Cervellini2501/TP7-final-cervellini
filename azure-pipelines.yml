# TP07 - Coverage, SonarCloud, Deploy to QA and Cypress E2E tests
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Variables compartidas (incluye SONAR_ORG, SONAR_PROJECT_KEY, SONAR_TOKEN)
  - group: TP7-Variables

  - name: nodeVersion
    value: '20.x'

  - name: azureSubscription
    value: 'azure-palabras-connection'

  # Nombre real de la App Service QA
  - name: webAppNameQA
    value: 'palabras-qa-vc'

  - name: webAppNamePROD
    value: 'palabras-prod'

# =======================================
# STAGE 1: Build and Test Backend + Frontend
# =======================================
stages:
- stage: BuildAndTest
  displayName: "Build & Test Backend + Frontend"
  jobs:
    - job: BuildAndTest
      displayName: 'Test, Coverage, and Build Job'
      steps:
        - checkout: self
          fetchDepth: 0

        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        # ===============================================
        # BACKEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm ci
          displayName: "Backend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Backend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        - task: PublishTestResults@2
          displayName: "Publish Backend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/backend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Backend Unit Tests'

        # âœ… BACKEND: Publish coverage con Cobertura
        - task: PublishCodeCoverageResults@2
          displayName: "Publish Backend Coverage"
          condition: succeededOrFailed()
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage/cobertura-coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/backend/coverage'
            failIfCoverageEmpty: true

        # âœ… BACKEND: Verificar coverage con Node y umbrales realistas
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend

            if [ ! -f "coverage/coverage-summary.json" ]; then
              echo "âŒ Coverage summary file not found"
              exit 1
            fi

            node - << 'EOF'
            const summary = require('./coverage/coverage-summary.json').total;

            console.log('Backend total coverage:', summary);

            const min = {
              statements: 60,
              branches:   60,
              functions:  50,
              lines:      60,
            };

            const fails = [];
            for (const key of Object.keys(min)) {
              const pct = summary[key]?.pct ?? 0;
              if (pct < min[key]) {
                fails.push(`${key}: ${pct}% < mÃ­nimo ${min[key]}%`);
              }
            }

            if (fails.length) {
              console.error('âŒ Coverage backend por debajo del mÃ­nimo:\n' + fails.join('\n'));
              process.exit(1);
            } else {
              console.log('âœ… Coverage backend OK, umbrales cumplidos.');
            }
            EOF
          displayName: "Backend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        # ===============================================
        # FRONTEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm ci
          displayName: "Frontend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Frontend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        - task: PublishTestResults@2
          displayName: "Publish Frontend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/frontend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Frontend Unit Tests'

        # âœ… FRONTEND: Publish coverage con Cobertura
        - task: PublishCodeCoverageResults@2
          displayName: "Publish Frontend Coverage"
          condition: succeededOrFailed()
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/frontend/coverage'
            failIfCoverageEmpty: true

        # âœ… FRONTEND: Verificar coverage con Node y umbrales alineados al Jest del front
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend

            if [ ! -f "coverage/coverage-summary.json" ]; then
              echo "âŒ Coverage summary file not found"
              exit 1
            fi

            node - << 'EOF'
            const summary = require('./coverage/coverage-summary.json').total;

            console.log('Frontend total coverage:', summary);

            const min = {
              statements: 70,
              branches:   65,
              functions:  70,
              lines:      70,
            };

            const fails = [];
            for (const key of Object.keys(min)) {
              const pct = summary[key]?.pct ?? 0;
              if (pct < min[key]) {
                fails.push(`${key}: ${pct}% < mÃ­nimo ${min[key]}%`);
              }
            }

            if (fails.length) {
              console.error('âŒ Coverage frontend por debajo del mÃ­nimo:\n' + fails.join('\n'));
              process.exit(1);
            } else {
              console.log('âœ… Coverage frontend OK, umbrales cumplidos.');
            }
            EOF
          displayName: "Frontend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        # ===============================================
        # SONARCLOUD
        # ===============================================
        - script: |
            set -e

            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  SONARCLOUD: Downloading SonarScanner CLI"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            curl -sSLo sonar-scanner.zip \
              https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip

            echo "Descomprimiendo SonarScanner..."
            unzip -q sonar-scanner.zip

            export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"

            echo "Ejecutando anÃ¡lisis SonarCloud..."
            sonar-scanner \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.organization=$(SONAR_ORG) \
              -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
              -Dsonar.token=$(SONAR_TOKEN) \
              -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
          displayName: 'SonarCloud - anÃ¡lisis'

        # ===============================================
        # BUILD Y PREPARAR ARTEFACTOS
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND BUILD"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm run build
            echo "âœ… Backend build completed"
          displayName: "Build Backend"

        - task: CopyFiles@2
          displayName: 'Copy Frontend to Backend'
          inputs:
            SourceFolder: 'frontend'
            Contents: |
              index.html
              app.js
              styles.css
            TargetFolder: 'backend/frontend'
            OverWrite: true

        - task: ArchiveFiles@2
          displayName: 'Archive Application Files'
          condition: succeeded()
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)/backend'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            replaceExistingArchive: true
            verbose: true

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Application Artifact'
          condition: succeeded()
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: 'drop'
            publishLocation: 'Container'

# =======================================
# STAGE 2: Deploy QA and Cypress tests
# =======================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
  - group: QA-Variables
  jobs:

    # JOB 1: Deploy a Azure QA
    - deployment: DeployToAzureQA
      displayName: 'Deploy to QA'
      environment: 'QA'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@1
                displayName: 'Download Artifacts'
                inputs:
                  buildType: 'current'
                  downloadType: 'single'
                  artifactName: 'drop'
                  downloadPath: '$(System.ArtifactsDirectory)'

              - task: AzureAppServiceSettings@1
                displayName: "Configure QA Environment Variables"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appName: "$(webAppNameQA)"
                  resourceGroupName: "palabras-qa-rg"
                  appSettings: |
                    [
                      { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
                      { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
                      { "name": "DB_PATH", "value": "$(DB_PATH)" }
                    ]

              - task: AzureWebApp@1
                displayName: 'Deploy to QA'
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webAppLinux'
                  appName: '$(webAppNameQA)'
                  package: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                  runtimeStack: 'NODE|20-lts'
                  startUpCommand: 'node index.js'

              - script: |
                  echo "Waiting for health endpoint to respond..."
                  url="https://$(webAppNameQA).azurewebsites.net/health"
                  timeout=120
                  interval=5
                  elapsed=0
                  until curl -sSf "$url" > /dev/null; do
                    sleep $interval
                    elapsed=$((elapsed + interval))
                    echo "Waiting... ${elapsed}s elapsed"
                    if [ $elapsed -ge $timeout ]; then
                      echo "Health check timed out after ${timeout}s"
                      exit 1
                    fi
                  done
                  echo "âœ… Health endpoint is OK: $url"
                displayName: 'Wait for /health (QA)'
                condition: succeeded()

    # JOB 2: Cypress Integration Tests
    - job: CypressIntegrationTests
      displayName: 'Cypress Integration Tests'
      dependsOn: DeployToAzureQA
      condition: succeeded()
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self
          fetchDepth: 0

        - task: NodeTool@0
          displayName: 'Install Node.js $(nodeVersion)'
          inputs:
            versionSpec: $(nodeVersion)

        - script: |
            echo "ğŸ“¦ Installing Cypress + E2E dependencies"
            cd $(System.DefaultWorkingDirectory)
            npm ci
            npm install --save-dev cypress mocha-junit-reporter wait-on @faker-js/faker
            npx cypress install || true
          displayName: 'Install Cypress + project deps'

        - script: |
            echo "ğŸŒ Esperando a que la app QA estÃ© online..."
            URL="https://$(webAppNameQA).azurewebsites.net"
            npx wait-on "$URL"
          displayName: 'Wait for deployed QA app to be ready'

        - script: |
            echo "=== Running Cypress E2E Tests ==="
            cd $(System.DefaultWorkingDirectory)
            ls -la
            npx cypress run \
              --browser chromium --headless \
              --config baseUrl=https://$(webAppNameQA).azurewebsites.net,pageLoadTimeout=120000,defaultCommandTimeout=15000
          displayName: 'Run Cypress E2E Tests'
          env:
            NODE_ENV: test
            CI: true

        - task: PublishTestResults@2
          displayName: 'Publish Cypress E2E Test Results'
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: 'cypress/results/*.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Cypress E2E Tests - $(Build.BuildNumber)'
            publishRunAttachments: true
